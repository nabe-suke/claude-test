# .github/workflows/claude-web-design-v3.yml
name: Claude Web Design Assistant v3

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  claude-web-designer:
    if: |
      (github.event_name == 'issues' && github.event.issue.body && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issue_comment' && github.event.comment.body && contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      pages: write
      id-token: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Get Issue Number
        uses: actions/github-script@v7
        with:
          script: |
            // Issue番号を取得（全イベント対応）
            let issueNumber;
            if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.issue && context.issue.number) {
              issueNumber = context.issue.number;
            } else {
              throw new Error('Issue番号を取得できません');
            }
            
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_ENV, `ISSUE_NUMBER=${issueNumber}\n`);
            console.log(`Issue番号: ${issueNumber}`);

      - name: Create feature branch and setup
        run: |
          BRANCH_NAME="feature/issue-${{ env.ISSUE_NUMBER }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Git設定
          git config --global user.name "Claude AI Assistant"
          git config --global user.email "claude@d-tech.local"
          
          # ブランチ作成とプッシュ
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          
      - name: Update Issue with branch info
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: `**自動処理開始**\n\n**作業ブランチ**: \`${{ env.BRANCH_NAME }}\`\n**ステータス**: コード変更中...\n**担当**: Claude AI Assistant`
            });

      - name: Generate website with Claude API
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Issue情報を環境変数に設定
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_ENV, `ISSUE_TITLE=${issue.data.title}\n`);
            fs.appendFileSync(process.env.GITHUB_ENV, `ISSUE_BODY=${issue.data.body.replace(/\n/g, '\\n')}\n`);
            
            console.log(`Issue #${issueNumber}: ${issue.data.title}`);
            console.log('Claude APIでウェブサイトを生成します...');

      - name: Read CLAUDE.md specifications
        run: |
          echo "CLAUDE_SPECS<<EOF" >> $GITHUB_ENV
          cat CLAUDE.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Call Claude API to generate website
        run: |
          node .github/scripts/claude-api.js
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
          ISSUE_BODY: ${{ env.ISSUE_BODY }}
          CLAUDE_SPECS: ${{ env.CLAUDE_SPECS }}

      - name: Commit generated website
        run: |
          git add preview/
          git commit -m "D's tech: Issue #${{ env.ISSUE_NUMBER }} に対応 - Claude AIによるウェブサイト生成"
          git push origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            
            // デフォルトブランチを取得
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repo.data.default_branch;
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `D's tech: Issue #${issueNumber} に対応`,
                head: '${{ env.BRANCH_NAME }}',
                base: defaultBranch,
                body: `## 概要\nIssue #${issueNumber} の要望に対応し、Claude AIがウェブサイトを自動生成しました。\n\n## 生成内容\n- Claude API (claude-3-5-sonnet-20241022) による完全自動生成\n- レスポンシブデザイン対応\n- D's tech情報を含む\n- 要望に応じたカスタム機能\n\n## プレビュー確認\nプレビューURLで生成されたサイトをご確認ください。\n問題なければマージしてください。\n\n## 関連Issue\nCloses #${issueNumber}\n\n---\n**自動生成**: Claude AI + GitHub Actions`
              });
              
              // PR番号を環境変数に保存
              const fs = require('fs');
              fs.appendFileSync(process.env.GITHUB_ENV, `PR_NUMBER=${pr.data.number}\n`);
              
              console.log(`PR #${pr.data.number} を作成しました`);
            } catch (error) {
              console.error('PR作成エラー:', error.message);
              throw error;
            }

      - name: Deploy PR Preview to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview
          publish_branch: gh-pages
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: true
          force_orphan: false

      - name: Wait for Pages deployment
        if: success()
        run: |
          echo "GitHub Pagesのデプロイを待機中..."
          sleep 60

      - name: Update Issue with completion and preview
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const prNumber = process.env.PR_NUMBER;
            const repoName = context.repo.repo;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${repoName}/pr-${prNumber}/`;
            
            // Issueを更新
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `**処理完了**\n\n**作成されたPR**: #${prNumber}\n**ブランチ**: \`${{ env.BRANCH_NAME }}\`\n\n## プレビューサイト\n**URL**: ${previewUrl}\n**注意**: プレビューの反映に2-3分かかる場合があります。\n\nプレビューで内容を確認後、問題なければPRをマージしてください。\n\n---\n\n**D's tech 情報**\n- 事業地: 茨城県阿見町\n- 料金: 月額1万円（税込）\n- 特徴: 個人事業主ならではの丁寧なサポート`
            });
            
            // PRにもプレビューリンクを追加
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: `## プレビューサイト\n\n**URL**: ${previewUrl}\n**注意**: プレビューの反映に2-3分かかる場合があります。\n\nプレビューで内容を確認し、問題なければマージしてください。\n\n**D's tech**: 茨城県阿見町のホームページ制作（月額1万円）`
            });
            
            // Issueにラベル追加
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['claude-processed', 'pr-created', 'preview-ready']
              });
            } catch (error) {
              console.log('ラベル追加に失敗しましたが、処理を継続します');
            }
            
      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Issue番号を取得（エラー時は環境変数がない可能性あり）
            let issueNumber;
            if (process.env.ISSUE_NUMBER) {
              issueNumber = parseInt(process.env.ISSUE_NUMBER);
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.issue && context.issue.number) {
              issueNumber = context.issue.number;
            } else {
              console.error('Issue番号を取得できません');
              return;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `**処理失敗**\n\n**詳細**: [ワークフロー実行ログ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})をご確認ください\n**再実行**: Issueを編集して再度 \`@claude\` でお試しください\n\n---\n\n**D's tech サポート**\nお困りの際はお気軽にお声がけください。`
            });
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['claude-failed']
              });
            } catch (error) {
              console.log('ラベル追加に失敗しましたが、エラーコメントは投稿しました');
            }