# .github/workflows/claude-web-design-v3.yml
name: Claude Web Design Assistant v3

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  claude-web-designer:
    if: |
      (github.event_name == 'issues' && github.event.issue.body && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issue_comment' && github.event.comment.body && contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Get Issue Number
        uses: actions/github-script@v7
        with:
          script: |
            // Issueç•ªå·ã‚’å–å¾—ï¼ˆå…¨ã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼‰
            let issueNumber;
            if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.issue && context.issue.number) {
              issueNumber = context.issue.number;
            } else {
              throw new Error('Issueç•ªå·ã‚’å–å¾—ã§ãã¾ã›ã‚“');
            }
            
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_ENV, `ISSUE_NUMBER=${issueNumber}\n`);
            console.log(`Issueç•ªå·: ${issueNumber}`);

      - name: Create feature branch and setup
        run: |
          BRANCH_NAME="feature/issue-${{ env.ISSUE_NUMBER }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Gitè¨­å®š
          git config --global user.name "Claude AI Assistant"
          git config --global user.email "claude@d-tech.local"
          
          # ãƒ–ãƒ©ãƒ³ãƒä½œæˆã¨ãƒ—ãƒƒã‚·ãƒ¥
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          
      - name: Update Issue with branch info
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: `ğŸš€ **è‡ªå‹•å‡¦ç†é–‹å§‹**\n\nğŸ“‹ **ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ env.BRANCH_NAME }}\`\nâ³ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ã‚³ãƒ¼ãƒ‰å¤‰æ›´ä¸­...\nğŸ¤– **æ‹…å½“**: Claude AI Assistant`
            });

      - name: Get Issue content and generate code
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const issueBody = issue.data.body || 'Issueå†…å®¹ãªã—';
            const issueTitle = issue.data.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
            
            // å®‰å…¨ãªæ–‡å­—åˆ—å‡¦ç†ï¼ˆHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
            const escapeHtml = (str) => str.replace(/[&<>"']/g, (match) => {
              const escapeMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
              return escapeMap[match];
            });
            
            const safeTitle = escapeHtml(issueTitle).substring(0, 100);
            const safeBody = escapeHtml(issueBody).substring(0, 200);
            
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
            const sampleContent = `<!-- D's tech - Issue #${issueNumber} å¯¾å¿œ -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${safeTitle} - D's tech</title>
</head>
<body>
    <h1>ğŸ¢ D's tech - ${safeTitle}</h1>
    <p>èŒ¨åŸçœŒé˜¿è¦‹ç”ºã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸åˆ¶ä½œã‚µãƒ¼ãƒ“ã‚¹</p>
    <p>æ–™é‡‘: æœˆé¡1ä¸‡å††ï¼ˆç¨è¾¼ï¼‰</p>
    <p>Issueå†…å®¹: ${safeBody}</p>
</body>
</html>`;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
            fs.writeFileSync('sample-page.html', sampleContent);
            
            console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ');

      - name: Commit changes
        run: |
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if git diff --quiet && git diff --cached --quiet; then
            echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç©ºã®ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚"
            git commit --allow-empty -m "ğŸ¢ D's tech: Issue #${{ env.ISSUE_NUMBER }} ã«å¯¾å¿œ (ç©ºã‚³ãƒŸãƒƒãƒˆ)"
          else
            git add .
            git commit -m "ğŸ¢ D's tech: Issue #${{ env.ISSUE_NUMBER }} ã«å¯¾å¿œ
          
          - ã‚µãƒ³ãƒ—ãƒ«ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
          - èŒ¨åŸçœŒé˜¿è¦‹ç”ºã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸åˆ¶ä½œã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œ
          - æ–™é‡‘: æœˆé¡1ä¸‡å††ï¼ˆç¨è¾¼ï¼‰ã®æƒ…å ±ã‚’å«ã‚€
          
          Closes #${{ env.ISSUE_NUMBER }}"
          fi
          git push origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repo.data.default_branch;
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¢ D's tech: Issue #${issueNumber} ã«å¯¾å¿œ`,
                head: '${{ env.BRANCH_NAME }}',
                base: defaultBranch,
                body: `## ğŸ¯ æ¦‚è¦\nIssue #${issueNumber} ã®è¦æœ›ã«å¯¾å¿œã—ãŸå®Ÿè£…ã§ã™ã€‚\n\n## ğŸ“ å¤‰æ›´å†…å®¹\n- ã‚µãƒ³ãƒ—ãƒ«ãƒšãƒ¼ã‚¸ã®ä½œæˆ\n- D's techã®äº‹æ¥­æƒ…å ±ï¼ˆèŒ¨åŸçœŒé˜¿è¦‹ç”ºãƒ»æœˆé¡1ä¸‡å††ï¼‰ã‚’å«ã‚€\n\n## ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ\n- ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆè¨­è¨ˆ\n- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å¯¾å¿œ\n\n## ğŸŒ SEOå¯¾ç­–\n- èŒ¨åŸçœŒé˜¿è¦‹ç”ºã®ãƒ­ãƒ¼ã‚«ãƒ«SEOã‚’è€ƒæ…®\n\n## ğŸ”— é–¢é€£Issue\nCloses #${issueNumber}\n\n---\nğŸ¤– **è‡ªå‹•ä½œæˆ**: GitHub Actions + Claude AI Assistant`
              });
              
              // PRç•ªå·ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
              const fs = require('fs');
              fs.appendFileSync(process.env.GITHUB_ENV, `PR_NUMBER=${pr.data.number}\n`);
              
              console.log(`PR #${pr.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            } catch (error) {
              console.error('PRä½œæˆã‚¨ãƒ©ãƒ¼:', error.message);
              throw error;
            }
          

          
      - name: Update Issue with completion
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            // Issueã‚’æ›´æ–°
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… **å‡¦ç†å®Œäº†**\n\nğŸ”— **ä½œæˆã•ã‚ŒãŸPR**: #${{ env.PR_NUMBER }}\nğŸ“‹ **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ env.BRANCH_NAME }}\`\nğŸ¯ **ãƒ¬ãƒ“ãƒ¥ãƒ¼**: PRã‚’ã”ç¢ºèªãã ã•ã„\n\n---\n\nğŸ¢ **D's tech æƒ…å ±**\n- äº‹æ¥­åœ°: èŒ¨åŸçœŒé˜¿è¦‹ç”º\n- æ–™é‡‘: æœˆé¡1ä¸‡å††ï¼ˆç¨è¾¼ï¼‰\n- ç‰¹å¾´: å€‹äººäº‹æ¥­ä¸»ãªã‚‰ã§ã¯ã®ä¸å¯§ãªã‚µãƒãƒ¼ãƒˆ`
            });
            
            // Issueã«ãƒ©ãƒ™ãƒ«è¿½åŠ 
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['ğŸ¤– claude-processed', 'ğŸ“‹ pr-created']
              });
            } catch (error) {
              console.log('ãƒ©ãƒ™ãƒ«è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™');
            }
            
      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Issueç•ªå·ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ç’°å¢ƒå¤‰æ•°ãŒãªã„å¯èƒ½æ€§ã‚ã‚Šï¼‰
            let issueNumber;
            if (process.env.ISSUE_NUMBER) {
              issueNumber = parseInt(process.env.ISSUE_NUMBER);
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.issue && context.issue.number) {
              issueNumber = context.issue.number;
            } else {
              console.error('Issueç•ªå·ã‚’å–å¾—ã§ãã¾ã›ã‚“');
              return;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âŒ **å‡¦ç†å¤±æ•—**\n\nğŸ” **è©³ç´°**: [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ã”ç¢ºèªãã ã•ã„\nğŸ”„ **å†å®Ÿè¡Œ**: Issueã‚’ç·¨é›†ã—ã¦å†åº¦ \`@claude\` ã§ãŠè©¦ã—ãã ã•ã„\n\n---\n\nğŸ¢ **D's tech ã‚µãƒãƒ¼ãƒˆ**\nãŠå›°ã‚Šã®éš›ã¯ãŠæ°—è»½ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚`
            });
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âŒ claude-failed']
              });
            } catch (error) {
              console.log('ãƒ©ãƒ™ãƒ«è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¯æŠ•ç¨¿ã—ã¾ã—ãŸ');
            }