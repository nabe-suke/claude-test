# .github/workflows/claude-web-design-v3.yml
name: Claude Web Design Assistant v3

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  claude-web-designer:
    if: |
      (github.event_name == 'issues' && github.event.issue.body && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issue_comment' && github.event.comment.body && contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      pages: write
      id-token: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Get Issue Number
        uses: actions/github-script@v7
        with:
          script: |
            // Issue番号を取得（全イベント対応）
            let issueNumber;
            if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.issue && context.issue.number) {
              issueNumber = context.issue.number;
            } else {
              throw new Error('Issue番号を取得できません');
            }
            
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_ENV, `ISSUE_NUMBER=${issueNumber}\n`);
            console.log(`Issue番号: ${issueNumber}`);

      - name: Create feature branch and setup
        run: |
          BRANCH_NAME="feature/issue-${{ env.ISSUE_NUMBER }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Git設定
          git config --global user.name "Claude AI Assistant"
          git config --global user.email "claude@d-tech.local"
          
          # ブランチ作成とプッシュ
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          
      - name: Update Issue with branch info
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: `**自動処理開始**\n\n**作業ブランチ**: \`${{ env.BRANCH_NAME }}\`\n**ステータス**: コード変更中...\n**担当**: Claude AI Assistant`
            });

      - name: Process Issue request
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            console.log(`Issue #${issueNumber}: ${issue.data.title}`);
            console.log('ワークフローテスト完了 - 実際の実装ではClaude APIを呼び出してコードを生成します');

      - name: Create preview HTML
        run: |
          mkdir -p preview
          cat > preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>D's tech - プレビュー (Issue #${{ env.ISSUE_NUMBER }})</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { background: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                  .status { background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>D's tech - プレビューサイト</h1>
                      <p>Issue #${{ env.ISSUE_NUMBER }} の対応プレビュー</p>
                  </div>
                  
                  <div class="status">
                      <h2>✅ プレビュー正常表示</h2>
                      <p>GitHub Pagesが正しく動作しています。</p>
                  </div>
                  
                  <div class="info">
                      <h3>D's tech について</h3>
                      <ul>
                          <li><strong>事業地</strong>: 茨城県阿見町</li>
                          <li><strong>料金</strong>: 月額1万円（税込）</li>
                          <li><strong>特徴</strong>: 個人事業主ならではの丁寧なサポート</li>
                      </ul>
                  </div>
                  
                  <div class="info">
                      <h3>技術情報</h3>
                      <ul>
                          <li><strong>ブランチ</strong>: ${{ env.BRANCH_NAME }}</li>
                          <li><strong>デプロイ時刻</strong>: $(date)</li>
                          <li><strong>Issue番号</strong>: #${{ env.ISSUE_NUMBER }}</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Create empty commit
        run: |
          git add preview/
          git commit -m "D's tech: Issue #${{ env.ISSUE_NUMBER }} に対応 - プレビューHTML作成"
          git push origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            
            // デフォルトブランチを取得
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repo.data.default_branch;
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `D's tech: Issue #${issueNumber} に対応`,
                head: '${{ env.BRANCH_NAME }}',
                base: defaultBranch,
                body: `## 概要\nIssue #${issueNumber} の要望に対応したワークフローテストです。\n\n## テスト内容\n- GitHub Actionsワークフローの動作確認\n- IssueからPR自動作成のテスト\n- GitHub Pagesプレビュー機能の検証\n- D's techサイト専用設定の検証\n\n## プレビュー確認\nプレビューURLがコメントで投稿されます。内容を確認後、問題なければマージしてください。\n\n## 次のステップ\n実際の実装ではClaude APIを呼び出してコードを生成します。\n\n## 関連Issue\nCloses #${issueNumber}\n\n---\n**自動作成**: GitHub Actions + Claude AI Assistant`
              });
              
              // PR番号を環境変数に保存
              const fs = require('fs');
              fs.appendFileSync(process.env.GITHUB_ENV, `PR_NUMBER=${pr.data.number}\n`);
              
              console.log(`PR #${pr.data.number} を作成しました`);
            } catch (error) {
              console.error('PR作成エラー:', error.message);
              throw error;
            }

      - name: Deploy PR Preview to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview
          publish_branch: gh-pages
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: true
          force_orphan: false

      - name: Wait for Pages deployment
        if: success()
        run: |
          echo "GitHub Pagesのデプロイを待機中..."
          sleep 60

      - name: Update Issue with completion and preview
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const prNumber = process.env.PR_NUMBER;
            const repoName = context.repo.repo;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${repoName}/pr-${prNumber}/`;
            
            // Issueを更新
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `**処理完了**\n\n**作成されたPR**: #${prNumber}\n**ブランチ**: \`${{ env.BRANCH_NAME }}\`\n\n## プレビューサイト\n**URL**: ${previewUrl}\n**注意**: プレビューの反映に2-3分かかる場合があります。\n\nプレビューで内容を確認後、問題なければPRをマージしてください。\n\n---\n\n**D's tech 情報**\n- 事業地: 茨城県阿見町\n- 料金: 月額1万円（税込）\n- 特徴: 個人事業主ならではの丁寧なサポート`
            });
            
            // PRにもプレビューリンクを追加
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: `## プレビューサイト\n\n**URL**: ${previewUrl}\n**注意**: プレビューの反映に2-3分かかる場合があります。\n\nプレビューで内容を確認し、問題なければマージしてください。\n\n**D's tech**: 茨城県阿見町のホームページ制作（月額1万円）`
            });
            
            // Issueにラベル追加
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['claude-processed', 'pr-created', 'preview-ready']
              });
            } catch (error) {
              console.log('ラベル追加に失敗しましたが、処理を継続します');
            }
            
      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Issue番号を取得（エラー時は環境変数がない可能性あり）
            let issueNumber;
            if (process.env.ISSUE_NUMBER) {
              issueNumber = parseInt(process.env.ISSUE_NUMBER);
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.issue && context.issue.number) {
              issueNumber = context.issue.number;
            } else {
              console.error('Issue番号を取得できません');
              return;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `**処理失敗**\n\n**詳細**: [ワークフロー実行ログ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})をご確認ください\n**再実行**: Issueを編集して再度 \`@claude\` でお試しください\n\n---\n\n**D's tech サポート**\nお困りの際はお気軽にお声がけください。`
            });
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['claude-failed']
              });
            } catch (error) {
              console.log('ラベル追加に失敗しましたが、エラーコメントは投稿しました');
            }