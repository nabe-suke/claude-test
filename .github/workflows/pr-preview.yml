# .github/workflows/pr-preview.yml
name: PR Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
      pull-requests: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create preview HTML
        run: |
          mkdir -p preview
          cat > preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>D's tech - PR #${{ github.event.number }} プレビュー</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { background: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                  .status { background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>D's tech - PRプレビュー</h1>
                      <p>Pull Request #${{ github.event.number }} のプレビュー</p>
                  </div>
                  
                  <div class="status">
                      <h2>✅ プレビュー正常表示</h2>
                      <p>GitHub Pagesが正しく動作しています。</p>
                  </div>
                  
                  <div class="info">
                      <h3>D's tech について</h3>
                      <ul>
                          <li><strong>事業地</strong>: 茨城県阿見町</li>
                          <li><strong>料金</strong>: 月額1万円（税込）</li>
                          <li><strong>特徴</strong>: 個人事業主ならではの丁寧なサポート</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview
          publish_branch: gh-pages
          destination_dir: pr-${{ github.event.number }}
          keep_files: true

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.repo.repo;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${repoName}/pr-${prNumber}/`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## 🚀 プレビューデプロイ完了\n\n**プレビューURL**: ${previewUrl}\n\n**注意**: 初回デプロイの場合、反映まで2-3分かかることがあります。\n\n---\n**D's tech**: 茨城県阿見町のホームページ制作（月額1万円）`
            });

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
      pull-requests: write
      
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove preview directory
        run: |
          if [ -d "pr-${{ github.event.number }}" ]; then
            rm -rf "pr-${{ github.event.number }}"
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "Remove preview for PR #${{ github.event.number }}" || echo "No changes to commit"
            git push
          else
            echo "Preview directory pr-${{ github.event.number }} not found"
          fi

      - name: Comment PR cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## 🗑️ プレビュークリーンアップ完了\n\nPR #${prNumber} のプレビューサイトを削除しました。\n\n---\n**D's tech**: 茨城県阿見町のホームページ制作（月額1万円）`
            });