# .github/workflows/pr-preview.yml
name: PR Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
      pull-requests: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create preview HTML
        run: |
          mkdir -p preview
          cat > preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>D's tech - PR #${{ github.event.number }} ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .header { background: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                  .status { background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
                  .info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>D's tech - PRãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
                      <p>Pull Request #${{ github.event.number }} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
                  </div>
                  
                  <div class="status">
                      <h2>âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ­£å¸¸è¡¨ç¤º</h2>
                      <p>GitHub PagesãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
                  </div>
                  
                  <div class="info">
                      <h3>D's tech ã«ã¤ã„ã¦</h3>
                      <ul>
                          <li><strong>äº‹æ¥­åœ°</strong>: èŒ¨åŸçœŒé˜¿è¦‹ç”º</li>
                          <li><strong>æ–™é‡‘</strong>: æœˆé¡1ä¸‡å††ï¼ˆç¨è¾¼ï¼‰</li>
                          <li><strong>ç‰¹å¾´</strong>: å€‹äººäº‹æ¥­ä¸»ãªã‚‰ã§ã¯ã®ä¸å¯§ãªã‚µãƒãƒ¼ãƒˆ</li>
                      </ul>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview
          publish_branch: gh-pages
          destination_dir: pr-${{ github.event.number }}
          keep_files: true

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoName = context.repo.repo;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${repoName}/pr-${prNumber}/`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†\n\n**ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${previewUrl}\n\n**æ³¨æ„**: åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã€åæ˜ ã¾ã§2-3åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\n\n---\n**D's tech**: èŒ¨åŸçœŒé˜¿è¦‹ç”ºã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸åˆ¶ä½œï¼ˆæœˆé¡1ä¸‡å††ï¼‰`
            });

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
      pull-requests: write
      
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove preview directory
        run: |
          if [ -d "pr-${{ github.event.number }}" ]; then
            rm -rf "pr-${{ github.event.number }}"
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "Remove preview for PR #${{ github.event.number }}" || echo "No changes to commit"
            git push
          else
            echo "Preview directory pr-${{ github.event.number }} not found"
          fi

      - name: Comment PR cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ğŸ—‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†\n\nPR #${prNumber} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\n---\n**D's tech**: èŒ¨åŸçœŒé˜¿è¦‹ç”ºã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸åˆ¶ä½œï¼ˆæœˆé¡1ä¸‡å††ï¼‰`
            });